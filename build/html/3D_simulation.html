<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3D ST dataset simulation &mdash; Spider v1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=92fd9be5" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5cb08e4e"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Tumor immune microenvironments ST dataset simulation" href="TIME_simulation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Spider
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Reference-based_simulation.html">Reference-based Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Benchmark_datasets_generation.html">Benchmark datasets generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="TIME_simulation.html">Tumor immune microenvironments ST dataset simulation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3D ST dataset simulation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#generated-gene-expression-profiles-using-reference-dataset">generated gene expression profiles using reference dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Visiualization-of-spatial-distribution">Visiualization of spatial distribution</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Spider</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">3D ST dataset simulation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/3D_simulation.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="3D-ST-dataset-simulation">
<h1>3D ST dataset simulation<a class="headerlink" href="#3D-ST-dataset-simulation" title="Link to this heading"></a></h1>
<p>We generate cell positions in a 10*10*10 spatial region and divide it into three regions, guiding the spatial distribution of cell types according to different cell type ratios and transition matrices.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">spider</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">anndata</span> <span class="k">as</span> <span class="nn">ad</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image_width</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">image_height</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">image_depth</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">cell_num</span><span class="o">=</span><span class="mi">10000</span>
<span class="n">Num_celltype</span><span class="o">=</span><span class="mi">4</span>
<span class="n">points_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image_width</span><span class="p">,</span> <span class="n">cell_num</span><span class="p">)</span>
<span class="n">points_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image_height</span><span class="p">,</span> <span class="n">cell_num</span><span class="p">)</span>
<span class="n">points_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image_depth</span><span class="p">,</span> <span class="n">cell_num</span><span class="p">)</span>
<span class="n">cell_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">points_x</span><span class="p">,</span> <span class="n">points_y</span><span class="p">,</span> <span class="n">points_z</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mixed_zone1</span> <span class="o">=</span> <span class="p">(</span><span class="n">cell_location</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> \
                 <span class="p">(</span><span class="n">cell_location</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> \
                 <span class="p">(</span><span class="n">cell_location</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">mixed_zone2</span> <span class="o">=</span> <span class="p">(</span><span class="n">cell_location</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">image_width</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> \
             <span class="p">(</span><span class="n">cell_location</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">image_height</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> \
             <span class="p">(</span><span class="n">cell_location</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">image_depth</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span>


<span class="n">other_zone</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">mixed_zone1</span> <span class="o">|</span> <span class="n">mixed_zone2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">zone1_location</span> <span class="o">=</span> <span class="n">cell_location</span><span class="p">[</span><span class="n">mixed_zone1</span><span class="p">]</span>
<span class="n">zone1_num</span> <span class="o">=</span> <span class="n">zone1_location</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Mixed</span>
<span class="n">prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.33</span><span class="p">,</span><span class="mf">0.33</span><span class="p">,</span><span class="mf">0.33</span><span class="p">])</span>
<span class="n">Num_ct_sample</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_ct_sample</span><span class="p">(</span><span class="n">Num_celltype</span> <span class="o">=</span> <span class="n">Num_celltype</span><span class="p">,</span> <span class="n">Num_sample</span> <span class="o">=</span>  <span class="n">zone1_num</span><span class="p">,</span> <span class="n">prior</span> <span class="o">=</span> <span class="n">prior</span><span class="p">)</span>
<span class="n">target_trans</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stripe_freq</span><span class="p">(</span><span class="n">Num_celltype</span><span class="p">)</span>
<span class="n">target_trans</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.45</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.45</span><span class="p">])</span>
<span class="n">target_trans</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[0.45, 0.45, 0.05, 0.05],
       [0.05, 0.45, 0.45, 0.05],
       [0.05, 0.05, 0.45, 0.45],
       [0.45, 0.05, 0.05, 0.45]])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simulate_10X_3d</span><span class="p">(</span><span class="n">cell_num</span><span class="o">=</span><span class="n">zone1_num</span><span class="p">,</span>
                              <span class="n">Num_celltype</span><span class="o">=</span><span class="n">Num_celltype</span><span class="p">,</span>
                              <span class="n">prior</span><span class="o">=</span><span class="n">prior</span><span class="p">,</span>
                              <span class="n">target_trans</span><span class="o">=</span><span class="n">target_trans</span><span class="p">,</span>

                              <span class="n">image_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                              <span class="n">image_height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                              <span class="n">image_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                              <span class="n">cell_location</span><span class="o">=</span><span class="n">zone1_location</span><span class="p">,</span>
                              <span class="n">tol</span><span class="o">=</span><span class="mf">2e-2</span><span class="p">,</span>
                              <span class="n">T</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
                              <span class="n">loop_times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">smallsample_max_iter</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
                              <span class="n">bigsample_max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
swap_num:  1
Refine cell type using Metropolis–Hastings algorithm.
Sample num:617
10000 iteration, error 0.767
20000 iteration, error 0.793
30000 iteration, error 0.782
40000 iteration, error 0.784
50000 iteration, error 0.766
60000 iteration, error 0.755
70000 iteration, error 0.783
80000 iteration, error 0.782
90000 iteration, error 0.776
100000 iteration, error 0.783
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">zone2_location</span> <span class="o">=</span> <span class="n">cell_location</span><span class="p">[</span><span class="n">mixed_zone2</span><span class="p">]</span>
<span class="n">zone2_num</span> <span class="o">=</span> <span class="n">zone2_location</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Mixed</span>
<span class="n">prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">0.33</span><span class="p">,</span><span class="mf">0.33</span><span class="p">,</span><span class="mf">0.33</span><span class="p">])</span>
<span class="n">Num_ct_sample</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_ct_sample</span><span class="p">(</span><span class="n">Num_celltype</span> <span class="o">=</span> <span class="n">Num_celltype</span><span class="p">,</span> <span class="n">Num_sample</span> <span class="o">=</span>  <span class="n">zone2_num</span><span class="p">,</span> <span class="n">prior</span> <span class="o">=</span> <span class="n">prior</span><span class="p">)</span>
<span class="n">target_trans</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">stripe_freq</span><span class="p">(</span><span class="n">Num_celltype</span><span class="p">)</span>
<span class="n">target_trans</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.45</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.45</span><span class="p">])</span>
<span class="n">target_trans</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[0.45, 0.45, 0.05, 0.05],
       [0.05, 0.45, 0.45, 0.05],
       [0.05, 0.05, 0.45, 0.45],
       [0.45, 0.05, 0.05, 0.45]])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simulate_10X_3d</span><span class="p">(</span><span class="n">cell_num</span><span class="o">=</span><span class="n">zone2_num</span><span class="p">,</span>
                              <span class="n">Num_celltype</span><span class="o">=</span><span class="n">Num_celltype</span><span class="p">,</span>
                              <span class="n">prior</span><span class="o">=</span><span class="n">prior</span><span class="p">,</span>
                              <span class="n">target_trans</span><span class="o">=</span><span class="n">target_trans</span><span class="p">,</span>

                              <span class="n">image_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                              <span class="n">image_height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                              <span class="n">image_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                              <span class="n">cell_location</span><span class="o">=</span><span class="n">zone2_location</span><span class="p">,</span>
                              <span class="n">tol</span><span class="o">=</span><span class="mf">2e-2</span><span class="p">,</span>
                              <span class="n">T</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
                              <span class="n">loop_times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">smallsample_max_iter</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
                              <span class="n">bigsample_max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
swap_num:  1
Refine cell type using Metropolis–Hastings algorithm.
Sample num:598
10000 iteration, error 0.802
20000 iteration, error 0.767
30000 iteration, error 0.794
40000 iteration, error 0.803
50000 iteration, error 0.803
60000 iteration, error 0.802
70000 iteration, error 0.776
80000 iteration, error 0.802
90000 iteration, error 0.796
100000 iteration, error 0.799
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">zone3_location</span> <span class="o">=</span> <span class="n">cell_location</span><span class="p">[</span><span class="n">other_zone</span><span class="p">]</span>
<span class="n">zone3_num</span> <span class="o">=</span> <span class="n">zone3_location</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Mixed</span>
<span class="n">prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.94</span><span class="p">,</span><span class="mf">0.02</span><span class="p">,</span><span class="mf">0.02</span><span class="p">,</span><span class="mf">0.02</span><span class="p">])</span>
<span class="n">Num_ct_sample</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_ct_sample</span><span class="p">(</span><span class="n">Num_celltype</span> <span class="o">=</span> <span class="n">Num_celltype</span><span class="p">,</span> <span class="n">Num_sample</span> <span class="o">=</span>  <span class="n">zone3_num</span><span class="p">,</span> <span class="n">prior</span> <span class="o">=</span> <span class="n">prior</span><span class="p">)</span>
<span class="n">target_trans</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">addictive_freq</span><span class="p">(</span><span class="n">Num_celltype</span><span class="p">)</span>
<span class="n">target_trans</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">target_trans</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">target_trans</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">target_trans</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[0.8       , 0.06666667, 0.06666667, 0.06666667],
       [0.25      , 0.25      , 0.25      , 0.25      ],
       [0.25      , 0.25      , 0.25      , 0.25      ],
       [0.25      , 0.25      , 0.25      , 0.25      ]])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_3</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">simulate_10X_3d</span><span class="p">(</span><span class="n">cell_num</span><span class="o">=</span><span class="n">zone3_num</span><span class="p">,</span>
                              <span class="n">Num_celltype</span><span class="o">=</span><span class="n">Num_celltype</span><span class="p">,</span>
                              <span class="n">prior</span><span class="o">=</span><span class="n">prior</span><span class="p">,</span>
                              <span class="n">target_trans</span><span class="o">=</span><span class="n">target_trans</span><span class="p">,</span>

                              <span class="n">image_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                              <span class="n">image_height</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                              <span class="n">image_depth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                              <span class="n">cell_location</span><span class="o">=</span><span class="n">zone3_location</span><span class="p">,</span>
                              <span class="n">tol</span><span class="o">=</span><span class="mf">2e-2</span><span class="p">,</span>
                              <span class="n">T</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span>
                              <span class="n">loop_times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">smallsample_max_iter</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span>
                              <span class="n">bigsample_max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
swap_num:  1
Refine cell type using Metropolis–Hastings algorithm.
Sample num:8785
10000 iteration, error 1.038
20000 iteration, error 1.036
30000 iteration, error 1.035
40000 iteration, error 1.035
50000 iteration, error 1.037
60000 iteration, error 1.035
70000 iteration, error 1.035
80000 iteration, error 1.037
90000 iteration, error 1.036
100000 iteration, error 1.038
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cell_location</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[2.5133301 , 9.3451748 , 5.92689996],
       [3.09320824, 6.25485754, 5.72664263],
       [2.68836415, 2.33030128, 4.20549689],
       ...,
       [1.18473939, 7.34316272, 7.21401793],
       [0.94701773, 3.89963518, 7.39188892],
       [2.23298101, 2.31052682, 7.65738106]])
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">celltype_assignment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">cell_num</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">celltype_assignment</span><span class="p">[</span><span class="n">mixed_zone1</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_1</span>
<span class="n">celltype_assignment</span><span class="p">[</span><span class="n">mixed_zone2</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_2</span>
<span class="n">celltype_assignment</span><span class="p">[</span><span class="n">other_zone</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_3</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<section id="generated-gene-expression-profiles-using-reference-dataset">
<h2>generated gene expression profiles using reference dataset<a class="headerlink" href="#generated-gene-expression-profiles-using-reference-dataset" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ref_path</span> <span class="o">=</span> <span class="s2">&quot;./Benchmark_datasets/&quot;</span>
<span class="n">ref_adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">ref_path</span> <span class="o">+</span> <span class="s2">&quot;use_ref.h5ad&quot;</span><span class="p">)</span>
<span class="n">ref_ct</span> <span class="o">=</span> <span class="n">ref_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">celltype</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">match_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">Num_celltype</span><span class="p">),</span><span class="n">ref_ct</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spider_adata</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_sim_cell_level_expr</span><span class="p">(</span><span class="n">celltype_assignment</span><span class="o">=</span><span class="n">celltype_assignment</span><span class="p">,</span>
                                   <span class="n">adata</span><span class="o">=</span><span class="n">ref_adata</span><span class="p">,</span>
                                   <span class="n">Num_celltype</span><span class="o">=</span><span class="n">Num_celltype</span><span class="p">,</span>
                                   <span class="n">Num_ct_sample</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">celltype_assignment</span><span class="p">),</span>
                                   <span class="n">match_list</span><span class="o">=</span><span class="n">match_list</span><span class="p">,</span>
                                   <span class="n">ct_key</span><span class="o">=</span><span class="s2">&quot;celltype&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spider_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;spatial&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_location</span>
<span class="n">spider_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;cell&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spider_adata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spider_adata</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 10000 × 882
    obs: &#39;celltype&#39;, &#39;label&#39;
    var: &#39;gene&#39;
    uns: &#39;svg_scanpy&#39;, &#39;svg_squidpy&#39;
    obsm: &#39;spatial&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="Visiualization-of-spatial-distribution">
<h2>Visiualization of spatial distribution<a class="headerlink" href="#Visiualization-of-spatial-distribution" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig1</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">plot_3d_cell_types</span><span class="p">(</span>
    <span class="n">spider_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;spatial&quot;</span><span class="p">],</span>
    <span class="n">spider_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">celltype</span><span class="p">,</span>
    <span class="n">interactive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;3d_cell_types_0710.html&quot;</span><span class="p">,</span>
    <span class="n">auto_open</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slices</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">slice_anndata_by_z</span><span class="p">(</span><span class="n">spider_adata</span><span class="p">,</span> <span class="n">z_key</span><span class="o">=</span><span class="s1">&#39;spatial&#39;</span><span class="p">,</span> <span class="n">z_bins</span><span class="o">=</span><span class="n">z_bins</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created slice 0 (Z=0.0-2.0) with 1994 cells
Created slice 1 (Z=2.0-4.0) with 1996 cells
Created slice 2 (Z=4.0-6.0) with 2039 cells
Created slice 3 (Z=6.0-8.0) with 1991 cells
Created slice 4 (Z=8.0-10.0) with 1980 cells
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assuming &#39;slices&#39; is your list of AnnData objects from slice_anndata_by_z()</span>
<span class="n">fig2</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">plot_z_slices</span><span class="p">(</span>
    <span class="n">slices</span><span class="p">,</span>
    <span class="n">output_path</span><span class="o">=</span><span class="s1">&#39;z_slices_visualization_0710.pdf&#39;</span><span class="p">,</span>
    <span class="n">figsize_per_slice</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/3D_simulation_30_0.png" src="_images/3D_simulation_30_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="TIME_simulation.html" class="btn btn-neutral float-left" title="Tumor immune microenvironments ST dataset simulation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Jiyuan Yang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>